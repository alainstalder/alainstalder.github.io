<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseGrengine.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">grengine</a> &gt; <a href="index.source.html" class="el_package">ch.grengine</a> &gt; <span class="el_source">BaseGrengine.java</span></div><h1>BaseGrengine.java</h1><pre class="source lang-java linenums">/*
   Copyright 2014-now by Alain Stalder. Made in Switzerland.

   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       https://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

package ch.grengine;

import ch.grengine.except.CompileException;
import ch.grengine.except.CreateException;
import ch.grengine.except.LoadException;
import ch.grengine.source.Source;
import ch.grengine.engine.Engine;
import ch.grengine.engine.Loader;
import ch.grengine.source.SourceFactory;

import java.io.Closeable;
import java.io.File;
import java.net.URL;
import java.util.HashMap;
import java.util.Map;

import groovy.lang.Binding;
import groovy.lang.Script;


/**
 * Abstract base {@link Grengine}.
 * &lt;p&gt;
 * Implements most convenience methods for using Grengine.
 * 
 * @since 1.0
 * 
 * @author Alain Stalder
 * @author Made in Switzerland.
 */
public abstract class BaseGrengine implements Closeable {
    
    /**
     * the engine that powers this Grengine.
     * 
     * @since 1.0
     */
    protected Engine engine;
    
    /**
     * the source factory used to create instances of {@link Source},
     * often implicitly from script text, file or URL.
     * 
     * @since 1.0
     */
    protected SourceFactory sourceFactory;
    
    /**
     * the default loader instance, which is implicitly used when no specific loader is indicated.
     * 
     * @since 1.0
     */
    protected Loader loader;
    
    /**
     * constructor.
     * 
     * @since 1.0
     */
<span class="fc" id="L76">    protected BaseGrengine() {</span>
<span class="fc" id="L77">    }</span>
        
    // Engine...
    
    /**
     * gets the engine.
     *
     * @return engine
     * 
     * @since 1.0
     */
    public Engine getEngine() {
<span class="fc" id="L89">        return engine;</span>
    }

    /**
     * gets the default loader instance, which is implicitly used when no specific loader is indicated.
     *
     * @return default loader instance
     *
     * @see Engine#getLoader()
     *
     * @since 1.0
     */
    public Loader getLoader() {
<span class="fc" id="L102">        return engine.getLoader();</span>
    }
    
    /**
     * creates and gets a new attached loader, backed by the same bytecode
     * as all other shared loaders created by this engine
     * and automatically updated if code layers are set.
     *
     * @return new attached loader
     * 
     * @since 1.0
     */
    public Loader newAttachedLoader() {
<span class="fc" id="L115">        return engine.newAttachedLoader();</span>
    }
    
    /**
     * creates and gets a new detached loader, backed initially by the same
     * bytecode as all attached loaders created by this engine,
     * but not updated if code layers are set.
     * &lt;p&gt;
     * For example, a web application might create a detached loader for
     * each new HTTP session: A new loader in order to separate static
     * variables of scripts between sessions (security feature); a detached
     * loader in order to keep code layers constant during the lifetime
     * of the session (consistent behavior of Groovy script calls).
     *
     * @return new detached loader
     * 
     * @since 1.0
     */
    public Loader newDetachedLoader() {
<span class="fc" id="L134">        return engine.newDetachedLoader();</span>
    }
    
    /**
     * loads the main class of the given source from the given loader.
     * &lt;p&gt;
     * Note that if a class with the main class name is available for loading,
     * but was not compiled as part of a set of {@link Source} that included
     * the given source, that class will not count for loading.
     *
     * @param loader loader
     * @param source source
     *
     * @return main class
     * @throws CompileException if compilation was necessary to load the class and failed
     * @throws LoadException if loading failed, including if the class was not found
     * 
     * @see Engine#loadMainClass(Loader loader, Source source)
     * 
     * @since 1.0
     */
    public abstract Class&lt;?&gt; loadMainClass(Loader loader, Source source);

    /**
     * loads the main class of the given source from the default loader.
     * &lt;p&gt;
     * Note that if a class with the main class name is available for loading,
     * but was not compiled as part of a set of {@link Source} that included
     * the given source, that class will not count for loading.
     *
     * @param source source
     *
     * @return main class
     * @throws CompileException if compilation was necessary to load the class and failed
     * @throws LoadException if loading failed, including if the class was not found
     *
     * @see Engine#loadMainClass(Loader loader, Source source)
     *
     * @since 1.1.1
     */
    public abstract Class&lt;?&gt; loadMainClass(Source source);

    /**
     * loads a class with the given name and from the given source from the given loader.
     * &lt;p&gt;
     * Note that if a class with the given class name is available for loading,
     * but was not compiled as part of a set of {@link Source} that included
     * the given source, that class will not count for loading.
     *
     * @param loader loader
     * @param source source
     * @param name class name
     *
     * @return class
     * @throws CompileException if compilation was necessary to load the class and failed
     * @throws LoadException if loading failed, including if the class was not found
     * 
     * @see Engine#loadClass(Loader loader, Source source, String name)
     * 
     * @since 1.0
     */
    public abstract Class&lt;?&gt; loadClass(Loader loader, Source source, String name);

    /**
     * loads a class with the given name and from the given source from the default loader.
     * &lt;p&gt;
     * Note that if a class with the given class name is available for loading,
     * but was not compiled as part of a set of {@link Source} that included
     * the given source, that class will not count for loading.
     *
     * @param source source
     * @param name class name
     *
     * @return class
     * @throws CompileException if compilation was necessary to load the class and failed
     * @throws LoadException if loading failed, including if the class was not found
     *
     * @see Engine#loadClass(Loader loader, Source source, String name)
     *
     * @since 1.1.1
     */
    public abstract Class&lt;?&gt; loadClass(Source source, String name);

    /**
     * loads a class by name from the given loader.
     * &lt;p&gt;
     * Note that a top code cache is not searched in this case,
     * because each set of source has its own top loader.
     *
     * @param loader loader
     * @param name class name
     *
     * @return class
     * @throws LoadException if loading failed, including if the class was not found
     * 
     * @see Engine#loadClass(Loader loader, String name)
     * 
     * @since 1.0
     */
    public abstract Class&lt;?&gt; loadClass(Loader loader, String name);

    /**
     * loads a class by name from the default loader.
     * &lt;p&gt;
     * Note that a top code cache is not searched in this case,
     * because each set of source has its own top loader.
     *
     * @param name class name
     *
     * @return class
     * @throws LoadException if loading failed, including if the class was not found
     *
     * @see Engine#loadClass(Loader loader, String name)
     *
     * @since 1.1.1
     */
    public abstract Class&lt;?&gt; loadClass(String name);

    /**
     * release metadata for all classed ever loaded using this engine.
     * &lt;p&gt;
     * Allows to remove metadata associated by Groovy (or Java) with a class,
     * which is often necessary to get on-the-fly garbage collection.
     * &lt;p&gt;
     * Generally call only when really done using this engine and
     * all loaded classes; subsequently trying to use this engine
     * or its classes results generally in undefined behavior.
     *
     * @since 1.1
     */
    @Override
    public void close() {
<span class="fc" id="L266">        engine.close();</span>
<span class="fc" id="L267">    }</span>

    /**
     * returns a new class loader based on the engine and the given loader.
     * &lt;p&gt;
     * Note that the returned class loader typically does not load classes
     * itself; it just wraps the engine and its loader.
     *
     * @param loader loader
     *
     * @return class loader
     * @throws NullPointerException if the loader is null
     * @throws IllegalArgumentException if the loader does not match the engine
     *
     * @since 1.3
     */
    public ClassLoader asClassLoader(final Loader loader) {
<span class="fc" id="L284">        return engine.asClassLoader(loader);</span>
    }

    /**
     * returns a new class loader based on the engine and its default attached loader.
     * &lt;p&gt;
     * Note that the returned class loader typically does not load classes
     * itself; it just wraps the engine and its loader.
     *
     * @return class loader
     *
     * @since 1.3
     */
    public ClassLoader asClassLoader() {
<span class="fc" id="L298">        return engine.asClassLoader(loader);</span>
    }

    // SourceFactory...
    
    /**
     * gets the source factory used to create instances of {@link Source},
     * often implicitly from script text or file or URL.
     *
     * @return source factory
     * 
     * @since 1.0
     */
    public SourceFactory getSourceFactory() {
<span class="fc" id="L312">        return sourceFactory;</span>
    }

    /**
     * gets source from script text.
     *
     * @param text script text
     *
     * @return source
     * 
     * @see SourceFactory#fromText(String text)
     */
    public Source source(final String text) {
<span class="fc" id="L325">        return sourceFactory.fromText(text);</span>
    }

    /**
     * gets source from script text and desired class name.
     *
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return source
     *
     * @see SourceFactory#fromText(String text, String desiredClassName)
     * 
     * @since 1.0
     */
    public Source source(final String text, final String desiredClassName) {
<span class="fc" id="L341">        return sourceFactory.fromText(text, desiredClassName);</span>
    }

    /**
     * gets source from script file.
     *
     * @param file script file
     *
     * @return source
     * 
     * @see SourceFactory#fromFile(File file)
     */
    public Source source(final File file) {
<span class="fc" id="L354">        return sourceFactory.fromFile(file);</span>
    }
    
    /**
     * gets source from script URL.
     *
     * @param url script URL
     *
     * @return source
     *
     * @see SourceFactory#fromUrl(URL url)
     * 
     * @since 1.0
     */
    public Source source(final URL url) {
<span class="fc" id="L369">        return sourceFactory.fromUrl(url);</span>
    }
    
    // Grengine...
    
    /**
     * loads a class (default loader, text-based source),
     * compiling first if necessary.
     *
     * @param text script text
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final String text) {
<span class="fc" id="L387">        return load(loader, sourceFactory.fromText(text));</span>
    }

    /**
     * loads a class (given loader, text-based source),
     * compiling first if necessary.
     *
     * @param loader loader
     * @param text script text
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Loader loader, final String text) {
<span class="fc" id="L404">        return load(loader, sourceFactory.fromText(text));</span>
    }

    /**
     * loads a class (default loader, text-based source with desired class name),
     * compiling first if necessary.
     *
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final String text, final String desiredClassName) {
<span class="fc" id="L421">        return load(loader, sourceFactory.fromText(text, desiredClassName));</span>
    }

    /**
     * loads a class (given loader, text-based source with desired class name),
     * compiling first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Loader loader, final String text, final String desiredClassName) {
<span class="fc" id="L439">        return load(loader, sourceFactory.fromText(text, desiredClassName));</span>
    }

    /**
     * loads a class (default loader, file-based source),
     * compiling first if necessary.
     *
     * @param file script file
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final File file) {
<span class="fc" id="L455">        return load(loader, sourceFactory.fromFile(file));</span>
    }

    /**
     * loads a class (given loader, file-based source),
     * compiling first if necessary.
     *
     * @param loader loader
     * @param file script file
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Loader loader, final File file) {
<span class="fc" id="L472">        return load(loader, sourceFactory.fromFile(file));</span>
    }
    
    /**
     * loads a class (default loader, URL-based source),
     * compiling first if necessary.
     *
     * @param url script URL
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final URL url) {
<span class="fc" id="L488">        return load(loader, sourceFactory.fromUrl(url));</span>
    }

    /**
     * loads a class (given loader, URL-based source),
     * compiling first if necessary.
     *
     * @param loader loader
     * @param url script URL
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Loader loader, final URL url) {
<span class="fc" id="L505">        return load(loader, sourceFactory.fromUrl(url));</span>
    }

    /**
     * loads a class (default loader, given source),
     * compiling first if necessary.
     *
     * @param source source
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Source source) {
<span class="fc" id="L521">        return loadMainClass(source);</span>
    }

    /**
     * loads a class (given loader, given source),
     * compiling first if necessary.
     *
     * @param loader loader
     * @param source source
     *
     * @return loaded class
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * 
     * @since 1.0
     */
    public Class&lt;?&gt; load(final Loader loader, final Source source) {
<span class="fc" id="L538">        return loadMainClass(loader, source);</span>
    }
    
    
    /**
     * creates an instance of {@link Script} from the given class.
     *
     * @param clazz class
     * 
     * @return new instance
     * @throws CreateException if could not create the instance or the given class is not a script
     * 
     * @since 1.0
     */
    public Script create(final Class&lt;?&gt; clazz) {
        try {
<span class="fc" id="L554">            return (Script)clazz.getConstructor().newInstance();</span>
<span class="fc" id="L555">        } catch (Exception e) {</span>
<span class="fc" id="L556">            throw new CreateException(&quot;Could not create script for class &quot; + clazz.getCanonicalName() + &quot;.&quot;, e);</span>
        }
    }
    
    
    /**
     * creates a script (default loader, text-based source),
     * compiling and loading first if necessary.
     *
     * @param text script text
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final String text) {
<span class="fc" id="L575">        return create(loader, sourceFactory.fromText(text));</span>
    }
    
    /**
     * creates a script (given loader, text-based source),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Loader loader, final String text) {
<span class="fc" id="L593">        return create(loader, sourceFactory.fromText(text));</span>
    }
    
    /**
     * creates a script (default loader, text-based source with desired class name),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final String text, final String desiredClassName) {
<span class="fc" id="L611">        return create(loader, sourceFactory.fromText(text, desiredClassName));</span>
    }
    
    /**
     * creates a script (given loader, text-based source with desired class name),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Loader loader, final String text, final String desiredClassName) {
<span class="fc" id="L630">        return create(loader, sourceFactory.fromText(text, desiredClassName));</span>
    }
    
    /**
     * creates a script (default loader, file-based source),
     * compiling and loading first if necessary.
     *
     * @param file script file
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final File file) {
<span class="fc" id="L647">        return create(loader, sourceFactory.fromFile(file));</span>
    }
    
    /**
     * creates a script (given loader, file-based source),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param file script file
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Loader loader, final File file) {
<span class="fc" id="L665">        return create(loader, sourceFactory.fromFile(file));</span>
    }
    
    /**
     * creates a script (default loader, URL-based source),
     * compiling and loading first if necessary.
     *
     * @param url script URL
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final URL url) {
<span class="fc" id="L682">        return create(loader, sourceFactory.fromUrl(url));</span>
    }
    
    /**
     * creates a script (given loader, URL-based source),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param url script URL
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Loader loader, final URL url) {
<span class="fc" id="L700">        return create(loader, sourceFactory.fromUrl(url));</span>
    }
    
    /**
     * creates a script (default loader, given source),
     * compiling and loading first if necessary.
     *
     * @param source source
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Source source) {
<span class="fc" id="L717">        return create(loader, source);</span>
    }
    
    /**
     * creates a script (given loader, given source),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param source source
     *
     * @return new instance
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * 
     * @since 1.0
     */
    public Script create(final Loader loader, final Source source) {
<span class="fc" id="L735">        final Class&lt;?&gt; clazz = load(loader, source);</span>
        try {
<span class="fc" id="L737">            return (Script)clazz.getConstructor().newInstance();</span>
<span class="fc" id="L738">        } catch (Throwable t) {</span>
<span class="fc" id="L739">            throw new CreateException(&quot;Could not create script for class '&quot; + clazz.getCanonicalName() + </span>
                    &quot;' from source &quot; + source + &quot;.&quot;, t);
        }
    }


    /**
     * creates an empty binding.
     * &lt;p&gt;
     * Same as {@code new Binding()}.
     *
     * @return new binding
     * 
     * @since 1.0
     */
    public Binding binding() {
<span class="fc" id="L755">        return new Binding();</span>
    }

    /**
     * creates a binding using the given key and value.
     *
     * @param key key
     * @param value value
     *
     * @return new binding
     *
     * @since 1.0
     */
    public Binding binding(final String key, final Object value) {
<span class="fc" id="L769">        final Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L770">        map.put(key, value);</span>
<span class="fc" id="L771">        return new Binding(map);</span>
    }

    /**
     * creates a binding using the given keys and values.
     *
     * @param key1 key 1
     * @param value1 value 1
     * @param key2 key 2
     * @param value2 value 2
     *
     * @return new binding
     *
     * @since 1.0
     */
    public Binding binding(final String key1, final Object value1, final String key2, final Object value2) {
<span class="fc" id="L787">        final Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L788">        map.put(key1, value1);</span>
<span class="fc" id="L789">        map.put(key2, value2);</span>
<span class="fc" id="L790">        return new Binding(map);</span>
    }

    /**
     * creates a binding using the given keys and values.
     *
     * @param key1 key 1
     * @param value1 value 1
     * @param key2 key 2
     * @param value2 value 2
     * @param key3 key 3
     * @param value3 value 3
     *
     * @return new binding
     *
     * @since 1.0
     */
    public Binding binding(final String key1, final Object value1, final String key2, final Object value2,
            final String key3, final Object value3) {
<span class="fc" id="L809">        final Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L810">        map.put(key1, value1);</span>
<span class="fc" id="L811">        map.put(key2, value2);</span>
<span class="fc" id="L812">        map.put(key3, value3);</span>
<span class="fc" id="L813">        return new Binding(map);</span>
    }

    /**
     * creates a binding using the given keys and values.
     *
     * @param key1 key 1
     * @param value1 value 1
     * @param key2 key 2
     * @param value2 value 2
     * @param key3 key 3
     * @param value3 value 3
     * @param key4 key 4
     * @param value4 value 4
     *
     * @return new binding
     *
     * @since 1.0
     */
    public Binding binding(final String key1, final Object value1, final String key2, final Object value2,
            final String key3, final Object value3, final String key4, final Object value4) {
<span class="fc" id="L834">        final Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L835">        map.put(key1, value1);</span>
<span class="fc" id="L836">        map.put(key2, value2);</span>
<span class="fc" id="L837">        map.put(key3, value3);</span>
<span class="fc" id="L838">        map.put(key4, value4);</span>
<span class="fc" id="L839">        return new Binding(map);</span>
    }

    /**
     * creates a binding using the given keys and values.
     *
     * @param key1 key 1
     * @param value1 value 1
     * @param key2 key 2
     * @param value2 value 2
     * @param key3 key 3
     * @param value3 value 3
     * @param key4 key 4
     * @param value4 value 4
     * @param key5 key 5
     * @param value5 value 5
     * @param moreKeyValuePairs must be an even number of arguments (key/value) and all keys must be strings
     * 
     * @throws IllegalArgumentException if the number of arguments is odd or if a key is not a string
     *
     * @return new binding
     *
     * @since 1.0
     */
    public Binding binding(final String key1, final Object value1, final String key2, final Object value2,
            final String key3, final Object value3, final String key4, final Object value4,
            final String key5, final Object value5, final Object... moreKeyValuePairs) {
<span class="fc" id="L866">        final int nFixed = 10;</span>
<span class="fc" id="L867">        final int nMore = moreKeyValuePairs.length;</span>
<span class="fc" id="L868">        final int n = nFixed + nMore;</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">        if (n % 2 != 0) {</span>
<span class="fc" id="L870">            throw new IllegalArgumentException(&quot;Odd number of arguments.&quot;);</span>
        }
<span class="fc" id="L872">        final Map&lt;String,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L873">        map.put(key1, value1);</span>
<span class="fc" id="L874">        map.put(key2, value2);</span>
<span class="fc" id="L875">        map.put(key3, value3);</span>
<span class="fc" id="L876">        map.put(key4, value4);</span>
<span class="fc" id="L877">        map.put(key5, value5);</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">        for (int i = 0; i &lt; nMore; i += 2) {</span>
<span class="fc" id="L879">            final Object keyObj = moreKeyValuePairs[i];</span>
<span class="fc bfc" id="L880" title="All 2 branches covered.">            if (!(keyObj instanceof String)) {</span>
<span class="fc" id="L881">                throw new IllegalArgumentException(&quot;Argument &quot; + (nFixed + i + 1) + &quot; is not a string.&quot;);</span>
            }
<span class="fc" id="L883">            map.put((String)keyObj, moreKeyValuePairs[i+1]);</span>
        }
<span class="fc" id="L885">        return new Binding(map);</span>
    }
        
    
    /**
     * runs the given script (empty binding).
     * &lt;p&gt;
     * Note that the script may throw anything, checked or unchecked.
     *
     * @param script script
     * 
     * @return what the script returned
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Script script) {
<span class="fc" id="L902">        return run(script, new Binding());</span>
    }
    
    /**
     * runs the given script (given binding).
     * &lt;p&gt;
     * Note that the script may throw anything, checked or unchecked.
     *
     * @param script script
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Script script, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L919">        return run(script, new Binding(bindingMap));</span>
    }
    
    /**
     * runs the given script (given binding).
     * &lt;p&gt;
     * Note that the script may throw anything, checked or unchecked.
     *
     * @param script script
     * @param binding binding
     *
     * @return what the script returned
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Script script, final Binding binding) {
<span class="fc" id="L936">        script.setBinding(binding);</span>
<span class="fc" id="L937">        return script.run();</span>
    }
    
    
    /**
     * creates and runs a script (default loader, text-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text) {
<span class="fc" id="L956">        return run(loader, sourceFactory.fromText(text), new Binding());</span>
    }

    /**
     * creates and runs a script (default loader, text-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L975">        return run(loader, sourceFactory.fromText(text), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (default loader, text-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text, final Binding binding) {
<span class="fc" id="L994">        return run(loader, sourceFactory.fromText(text), binding);</span>
    }

    /**
     * creates and runs a script (given loader, text-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text) {
<span class="fc" id="L1013">        return run(loader, sourceFactory.fromText(text), new Binding());</span>
    }

    /**
     * creates and runs a script (given loader, text-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text, Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1033">        return run(loader, sourceFactory.fromText(text), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (given loader, text-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text, final Binding binding) {
<span class="fc" id="L1053">        return run(loader, sourceFactory.fromText(text), binding);</span>
    }


    /**
     * creates and runs a script (default loader, text-based source with desired class name, empty binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text, final String desiredClassName) {
<span class="fc" id="L1073">        return run(loader, sourceFactory.fromText(text, desiredClassName), new Binding());</span>
    }

    /**
     * creates and runs a script (default loader, text-based source with desired class name, given binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param desiredClassName desired class name
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text, final String desiredClassName, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1093">        return run(loader, sourceFactory.fromText(text, desiredClassName), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (default loader, text-based source with desired class name, given binding),
     * compiling and loading first if necessary.
     *
     * @param text script text
     * @param desiredClassName desired class name
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final String text, final String desiredClassName, final Binding binding) {
<span class="fc" id="L1113">        return run(loader, sourceFactory.fromText(text, desiredClassName), binding);</span>
    }

    /**
     * creates and runs a script (given loader, text-based source with desired class name, empty binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param desiredClassName desired class name
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text, final String desiredClassName) {
<span class="fc" id="L1133">        return run(loader, sourceFactory.fromText(text, desiredClassName), new Binding());</span>
    }

    /**
     * creates and runs a script (given loader, text-based source with desired class name, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param desiredClassName desired class name
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text, final String desiredClassName,
            final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1155">        return run(loader, sourceFactory.fromText(text, desiredClassName), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (given loader, text-based source with desired class name, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param text script text
     * @param desiredClassName desired class name
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final String text, final String desiredClassName,
            final Binding binding) {
<span class="fc" id="L1177">        return run(loader, sourceFactory.fromText(text, desiredClassName), binding);</span>
    }

    
    /**
     * creates and runs a script (default loader, file-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param file script file
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final File file) {
<span class="fc" id="L1196">        return run(loader, sourceFactory.fromFile(file), new Binding());</span>
    }

    /**
     * creates and runs a script (default loader, file-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param file script file
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final File file, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1215">        return run(loader, sourceFactory.fromFile(file), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (default loader, file-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param file script file
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final File file, final Binding binding) {
<span class="fc" id="L1234">        return run(loader, sourceFactory.fromFile(file), binding);</span>
    }

    /**
     * creates and runs a script (given loader, file-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param file script file
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final File file) {
<span class="fc" id="L1253">        return run(loader, sourceFactory.fromFile(file), new Binding());</span>
    }

    /**
     * creates and runs a script (given loader, file-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param file script file
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final File file, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1273">        return run(loader, sourceFactory.fromFile(file), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (given loader, file-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param file script file
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final File file, final Binding binding) {
<span class="fc" id="L1293">        return run(loader, sourceFactory.fromFile(file), binding);</span>
    }

    
    /**
     * creates and runs a script (default loader, URL-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param url script URL
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final URL url) {
<span class="fc" id="L1312">        return run(loader, sourceFactory.fromUrl(url), new Binding());</span>
    }

    /**
     * creates and runs a script (default loader, URL-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param url script URL
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final URL url, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1331">        return run(loader, sourceFactory.fromUrl(url), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (default loader, URL-based source, new binding),
     * compiling and loading first if necessary.
     *
     * @param url script URL
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final URL url, final Binding binding) {
<span class="fc" id="L1350">        return run(loader, sourceFactory.fromUrl(url), binding);</span>
    }

    /**
     * creates and runs a script (given loader, URL-based source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param url script URL
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final URL url) {
<span class="fc" id="L1369">        return run(loader, sourceFactory.fromUrl(url), new Binding());</span>
    }

    /**
     * creates and runs a script (given loader, URL-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param url script URL
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final URL url, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1389">        return run(loader, sourceFactory.fromUrl(url), new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (given loader, URL-based source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param url script URL
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final URL url, final Binding binding) {
<span class="fc" id="L1409">        return run(loader, sourceFactory.fromUrl(url), binding);</span>
    }

    
    /**
     * creates and runs a script (default loader, given source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param source source
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Source source) {
<span class="fc" id="L1428">        return run(loader, source, new Binding());</span>
    }

    /**
     * creates and runs a script (default loader, given source, given binding),
     * compiling and loading first if necessary.
     *
     * @param source source
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Source source, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1447">        return run(loader, source, new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (default loader, given source, given binding),
     * compiling and loading first if necessary.
     *
     * @param source source
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Source source, final Binding binding) {
<span class="fc" id="L1466">        return run(loader, source, binding);</span>
    }

    /**
     * creates and runs a script (given loader, given source, empty binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param source source
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final Source source) {
<span class="fc" id="L1485">        return run(loader, source, new Binding());</span>
    }

    /**
     * creates and runs a script (given loader, given source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param source source
     * @param bindingMap binding map
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final Source source, final Map&lt;String,Object&gt; bindingMap) {
<span class="fc" id="L1505">        return run(loader, source, new Binding(bindingMap));</span>
    }

    /**
     * creates and runs a script (given loader, given source, given binding),
     * compiling and loading first if necessary.
     *
     * @param loader loader
     * @param source source
     * @param binding binding
     *
     * @return what the script returned
     * @throws CompileException if compiling failed
     * @throws LoadException if loading failed
     * @throws CreateException if could not create the instance or is not a script
     * @grengine.scriptthrows {@link Throwable} - anything (checked or unchecked) that {@link Script#run()} may throw
     * 
     * @since 1.0
     */
    public Object run(final Loader loader, final Source source, final Binding binding) {
<span class="fc" id="L1525">        final Script script = create(loader, source);</span>
<span class="fc" id="L1526">        script.setBinding(binding);</span>
<span class="fc" id="L1527">        return script.run();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>